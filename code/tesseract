import numpy as np
import matplotlib.pyplot as plt
from scipy.ndimage import convolve, gaussian_filter
from skimage.measure import label, regionprops
from skimage.morphology import remove_small_objects
from skimage.filters import threshold_otsu
from skimage.color import rgb2gray
from PIL import Image
import pytesseract


# -- Chemin Tesseract Windows --
pytesseract.pytesseract.tesseract_cmd = r"C:\Users\Théo\AppData\Local\Programs\Tesseract-OCR\tesseract.exe"


def detect_layout_from_image():

    img_color = plt.imread("QWERTY.jpg")

    # Convertie en gris
    if img_color.ndim == 3:
        img_gray = rgb2gray(img_color)
    else:
        img_gray = img_color

    # Lissage
    img_smooth = gaussian_filter(img_gray, sigma=1.0)

    # Scharr filters
    scharr_x = np.array([
        [-3, 0, 3],
        [-10, 0, 10],
        [-3, 0, 3]
    ])

    scharr_y = np.array([
        [-3, -10, -3],
        [0, 0, 0],
        [3, 10, 3]
    ])

    # Gradient Scharr
    gx = convolve(img_smooth, scharr_x)
    gy = convolve(img_smooth, scharr_y)
    mag = np.sqrt(gx**2 + gy**2)

    # Binarisation Otsu
    t = threshold_otsu(mag)
    edges_bin = mag > t

    # Supprimer bruit
    edges_bin = remove_small_objects(edges_bin, min_size=80)

    # Détection composantes
    labels = label(edges_bin)
    regions = regionprops(labels)

    print(f"Régions détectées : {len(regions)}")

    # Visualisation
    fig, ax = plt.subplots(1, figsize=(12, 8))
    ax.imshow(img_gray, cmap='gray')

    detected_keys = []

    for r in regions:
        minr, minc, maxr, maxc = r.bbox
        h = maxr - minr
        w = maxc - minc

        # Filtrer les régions plausibles (trop petites ou trop grandes)
        if h < 20 or w < 20:
            continue
        if h > 200 or w > 200:
            continue

        # Extraire patch de la touche
        patch = img_gray[minr:maxr, minc:maxc]
        patch_uint8 = (patch * 255).astype(np.uint8)
        pil_img = Image.fromarray(patch_uint8)

        # OCR
        text = pytesseract.image_to_string(
            pil_img,
            config="--psm 7 -c tessedit_char_whitelist=ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
        )

        text = text.strip()

        if text != "":
            detected_keys.append((text, (minr, minc, maxr, maxc)))
            # Dessiner rectangle
            ax.add_patch(plt.Rectangle((minc, minr), w, h, fill=False, edgecolor='red', linewidth=2))
            ax.text(minc, minr - 5, text, color='yellow', fontsize=12, weight='bold')

    print("\nTouches reconnues :")
    for txt, box in detected_keys:
        print(txt, box)

    plt.title("OCR - Touches détectées")
    plt.axis('off')
    plt.show()

    return detected_keys


detect_layout_from_image()
